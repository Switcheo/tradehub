# Mainnet v1.6.0 to v1.8.0 upgrade instructions

**:exclamation: Run these steps in sequence. You need to apply both v1.6.0+cosmovisor and v1.8.0 upgrade. :exclamation:**

The following patch will allow cosmovisor daemon to facilitate future upgrades. You can read more about it [here](https://github.com/cosmos/cosmos-sdk/tree/master/cosmovisor).

Do not apply [step 3](#cleanup-after-v180-is-live) update until v1.8.0 is live. v1.8.0 is scheduled on block 2280000.

<br><br>

# 1. v1.6.0+cosmovisor upgrade

## 1.1. update ~/.env_switcheo

New env vars are needed to support cosmovisor. Leave WALLET_PASSWORD value blank.

```bash
# remove
export MINFDS=<value>
# add
export WALLET_PASSWORD=
export DAEMON_NAME=switcheod
export DAEMON_HOME=${HOME}/.switcheod
export PATH=${HOME}/.switcheod/cosmovisor/current/bin:${HOME}/.switcheod/cosmovisor/genesis/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin
```

## 1.2. add systemd service

We will be using systemctl instead of supervisorctl. Removal of supervisorctl will be in step 1.5.

```bash
# setup switcheod config
sudo rm -f /etc/systemd/system/switcheod.service && \
CURRENT_USER=$USER \
sudo -E bash -c 'cat <<EOT >> /etc/systemd/system/switcheod.service
[Unit]
Description=switcheod service
After=network.target
StartLimitIntervalSec=0
[Service]
Type=simple
Restart=always
RestartSec=5
User=${CURRENT_USER}
ExecStart=/bin/bash -c "source ~/.env_switcheo; killall -w -s 9 switcheod switcheocli; cosmovisor start-all -a"
LimitNOFILE=1024
[Install]
WantedBy=multi-user.target
EOT
'
```

## 1.3. setup cosmovisor directories

Prepare directory structure for cosmovisor.

```bash
mkdir -p ~/.switcheod/cosmovisor/genesis/bin ~/.switcheod/cosmovisor/upgrades
```

## 1.4. restart shell

```bash
exec $SHELL
```

## 1.5. download and update v1.6.0+cosmovisor bundle

We will be placing v1.6.0+cosmovisor switcheod and switcheocli in genesis directory, so cosmovisor will start with this version.

```bash
# switcheoctl stop first before download release
switcheoctl stop

curl -L https://github.com/Switcheo/tradehub/releases/download/v1.6.0%2Bcosmovisor/install-mainnet.tar.gz | tar -xz
cd install-mainnet && sudo ./install.sh && cd - && rm -rf install-mainnet

# switcheod and switcheocli will be available in ~/.switcheod/cosmovisor/
sudo rm -f /usr/local/bin/switcheod
sudo rm -f /usr/local/bin/switcheocli
sudo cp /etc/switcheoctl/bin/cosmovisor /usr/local/bin
sudo cp /etc/switcheoctl/bin/switcheod ~/.switcheod/cosmovisor/genesis/bin
sudo cp /etc/switcheoctl/bin/switcheocli ~/.switcheod/cosmovisor/genesis/bin

# sentry node, non-validator node or
switcheoctl start -n
# validator node
switcheoctl start
```

## 1.6. cleanup

```bash
# remove supervisorctl
sudo apt-get purge --auto-remove -y supervisor
sudo rm -f /etc/supervisor/conf.d/switcheod.conf
```

<br><br>

# 2. v1.8.0 upgrade

We will be placing v1.8.0 switcheod and switcheocli in upgrades directory. Cosmovisor will switch to the right binary during the right block height.

## 2.1. download and update v1.8.0 bundle
```bash
curl -L https://github.com/Switcheo/tradehub/releases/download/v1.8.0/install-mainnet.tar.gz | tar -xz
cd install-mainnet && sudo ./install.sh && cd - && rm -rf install-mainnet

switcheoctl stop
sudo cp /etc/switcheoctl/bin/cosmovisor /usr/local/bin
mkdir -p ~/.switcheod/cosmovisor/upgrades/v1.8.0/bin
sudo cp /etc/switcheoctl/bin/switcheod ~/.switcheod/cosmovisor/upgrades/v1.8.0/bin
sudo cp /etc/switcheoctl/bin/switcheocli ~/.switcheod/cosmovisor/upgrades/v1.8.0/bin

# sentry node, non-validator node or
switcheoctl start -n
# validator node
switcheoctl start
```

## 2.2. check that you are running version v1.6.0+cosmovisor

Ensure that you're running v1.6.0+cosmovisor since v1.8.0 upgrade has yet to take place.

```bash
# check version is patched correctly
curl -s localhost:1318/node_info | jq -r '.application_version.version'
```

Note that v1.8.0 will be running automatically after block 2280000. You may check the version of your node again after block 2280000.

<br><br>

# 3. cleanup after v1.8.0 is live

These steps should be performed after v1.8.0 is live after block 2280000, since they may cause the app to break if they are applied before.

```bash
# update logrotate: rename ~/.switcheo_logs/ to ~/.switcheod/logs/
sudo vim /etc/logrotate.d/switcheo_logs
# remove
$HOME/.switcheo_logs/*.log ${HOME}/.switcheo_logs/*.err {
    olddir ${HOME}/.switcheo_logs/old
# add
$HOME/.switcheod/logs/*.log ${HOME}/.switcheod/logs/*.err {
    olddir ${HOME}/.switcheod/logs/old
```
```bash
switcheoctl stop
# copy these if ~/.switcheod/config/fee.json, ~/.switcheod/config/ethpayer.json, ~/.switcheod/config/extevents.json doesn't exist
cp /etc/switcheoctl/etc/.switcheod/config/fee.json ~/.switcheod/config/
cp /etc/switcheoctl/etc/.switcheod/config/ethpayer.json ~/.switcheod/config/
cp /etc/switcheoctl/etc/.switcheod/config/extevents.json ~/.switcheod/config/

# sentry node, non-validator node or
switcheoctl start -n
# validator node
switcheoctl start
```
